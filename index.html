<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€DEMOã€‘å¥½å¥½çµå¸³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            max-width: 520px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff9100 0%, #ff7700 100%);
            color: white;
            padding: 28px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.95;
            font-size: 14px;
            font-weight: 400;
        }

        .content {
            padding: 30px;
        }

        .verification-section,
        .payment-section {
            display: none;
        }

        .verification-section.active,
        .payment-section.active {
            display: block;
        }

        .attempts-counter {
            background: #fffbf0;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .attempts-counter.danger {
            background: #fff5f5;
            border-color: #ff6b6b;
            color: #c92a2a;
        }

        .question-box {
            background: #fafbfc;
            padding: 22px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-left: 4px solid #ff9100;
        }

        .question-box h3 {
            color: #333;
            margin-bottom: 16px;
            font-size: 15px;
            font-weight: 600;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .image-option {
            aspect-ratio: 1;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            background: white;
        }

        .image-option:hover {
            border-color: #ff9100;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 145, 0, 0.15);
        }

        .image-option.selected {
            border-color: #ff9100;
            background: #fff8f0;
            box-shadow: 0 0 0 3px rgba(255, 145, 0, 0.1);
        }

        .text-input {
            width: 100%;
            padding: 14px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .text-input:focus {
            outline: none;
            border-color: #ff9100;
            box-shadow: 0 0 0 3px rgba(255, 145, 0, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
        }

        .btn-primary {
            background: #ff9100;
            color: white;
        }

        .btn-primary:hover {
            background: #ff7700;
            box-shadow: 0 4px 12px rgba(255, 145, 0, 0.35);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #868e96;
            color: white;
        }

        .btn-secondary:hover {
            background: #6c757d;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.25);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ff9100;
            box-shadow: 0 0 0 3px rgba(255, 145, 0, 0.1);
        }

        .form-group input:read-only {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .error-message {
            background: #fff5f5;
            border: 1px solid #ff6b6b;
            color: #c92a2a;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            animation: shake 0.5s;
        }

        .blocked-message {
            text-align: center;
            padding: 40px 20px;
        }

        .blocked-message .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .blocked-message h2 {
            color: #dc3545;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .blocked-message p {
            color: #6c757d;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-8px);
            }

            75% {
                transform: translateX(8px);
            }
        }

        .card-logos {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .card-logo {
            font-size: 11px;
            padding: 4px 10px;
            background: #f1f3f5;
            border-radius: 4px;
            color: #6c757d;
            font-weight: 500;
        }

        /* ä»˜æ¬¾å€’æ•¸è¨ˆæ™‚ */
        .payment-timer {
            background: #fff9e6;
            border: 1px solid #ffb700;
            color: #996a00;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .payment-timer.warning {
            background: #fff5f5;
            border-color: #ff6b6b;
            color: #c92a2a;
            animation: pulse 1.5s infinite;
        }

        .timer-display {
            font-size: 20px;
            font-weight: 700;
            margin: 0 4px;
            font-family: 'Courier New', monospace;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.85;
            }
        }

        .payment-expired {
            text-align: center;
            padding: 40px 20px;
        }

        .payment-expired .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .payment-expired h2 {
            color: #dc3545;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .payment-expired p {
            color: #6c757d;
            margin-bottom: 20px;
        }

        /* 3DS é©—è­‰æ¨£å¼ */
        .tds-container {
            max-width: 460px;
            margin: 0 auto;
        }

        .tds-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: linear-gradient(135deg, #ff9100 0%, #ff7700 100%);
            color: white;
            border-radius: 6px 6px 0 0;
            margin: -30px -30px 0 -30px;
        }

        .tds-header img {
            height: 22px;
        }

        .tds-lock {
            font-size: 18px;
        }

        .tds-content {
            padding: 20px 0;
        }

        .tds-info {
            text-align: center;
            margin-bottom: 24px;
        }

        .tds-info h3 {
            color: #212529;
            margin-bottom: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .tds-info p {
            color: #6c757d;
            font-size: 14px;
        }

        .tds-transaction {
            background: #fafbfc;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .tds-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .tds-row:last-child {
            border-bottom: none;
        }

        .tds-row span {
            color: #6c757d;
            font-size: 13px;
        }

        .tds-row strong {
            color: #212529;
            font-size: 13px;
            font-weight: 600;
        }

        .tds-verify-box {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .tds-sms-info {
            text-align: center;
            color: #28a745;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .tds-phone {
            text-align: center;
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 20px;
        }

        .tds-input {
            width: 100%;
            padding: 14px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 22px;
            text-align: center;
            letter-spacing: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tds-input:focus {
            outline: none;
            border-color: #ff9100;
            box-shadow: 0 0 0 3px rgba(255, 145, 0, 0.1);
        }

        .tds-timer {
            text-align: center;
            margin: 16px 0;
            padding: 12px;
            background: #fff9e6;
            border-radius: 6px;
            font-size: 13px;
            color: #996a00;
            border: 1px solid #ffe066;
        }

        .tds-timer span {
            font-weight: 600;
            font-size: 15px;
        }

        .tds-help {
            text-align: center;
            margin-top: 16px;
            font-size: 13px;
        }

        .tds-help a {
            color: #ff9100;
            text-decoration: none;
            font-weight: 500;
        }

        .tds-help a:hover {
            text-decoration: underline;
        }

        .tds-footer {
            text-align: center;
            padding: 16px;
            background: #fafbfc;
            border-radius: 6px;
            font-size: 12px;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading-animation {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f1f3f5;
            border-top: 4px solid #ff9100;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-animation h3 {
            color: #212529;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .loading-animation p {
            color: #6c757d;
            font-size: 14px;
        }

        /* æˆåŠŸå‹•ç•« */
        .success-animation {
            text-align: center;
            padding: 40px 20px;
        }

        .checkmark {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #28a745;
            color: white;
            font-size: 42px;
            line-height: 70px;
            margin: 0 auto 20px;
            animation: scaleIn 0.4s ease-out;
        }

        @keyframes scaleIn {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.08);
            }

            100% {
                transform: scale(1);
            }
        }

        .success-animation h2 {
            color: #28a745;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .success-animation p {
            color: #6c757d;
            margin-bottom: 28px;
            font-size: 14px;
        }

        .receipt {
            background: #fafbfc;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
            border: 1px solid #e9ecef;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .receipt-row:last-child {
            border-bottom: none;
        }

        .receipt-row span {
            color: #6c757d;
            font-size: 13px;
        }

        .receipt-row strong {
            color: #212529;
            font-size: 13px;
            font-weight: 600;
        }

        /* éŒ¯èª¤å‹•ç•« */
        .error-animation {
            text-align: center;
            padding: 40px 20px;
        }

        .error-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            font-size: 42px;
            line-height: 70px;
            margin: 0 auto 20px;
        }

        .error-animation h2 {
            color: #dc3545;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .error-animation p {
            color: #6c757d;
            margin-bottom: 28px;
            font-size: 14px;
        }

        /* RWD éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
                border-radius: 0;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 13px;
            }

            .content {
                padding: 20px 15px;
            }

            .question-box {
                padding: 18px;
            }

            .question-box h3 {
                font-size: 14px;
            }

            .image-grid {
                gap: 8px;
            }

            .image-option {
                font-size: 40px;
            }

            .btn {
                padding: 13px;
                font-size: 14px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .form-group input {
                padding: 11px 12px;
                font-size: 14px;
            }

            .payment-timer {
                padding: 12px;
                font-size: 13px;
            }

            .timer-display {
                font-size: 18px;
            }

            .attempts-counter {
                padding: 12px;
                font-size: 13px;
            }

            .tds-header {
                padding: 15px;
                margin: -20px -15px 0 -15px;
            }

            .tds-header div:first-child {
                font-size: 14px;
            }

            .tds-info h3 {
                font-size: 17px;
            }

            .tds-info p {
                font-size: 13px;
            }

            .tds-transaction {
                padding: 14px;
            }

            .tds-row {
                padding: 8px 0;
            }

            .tds-row span,
            .tds-row strong {
                font-size: 12px;
            }

            .tds-verify-box {
                padding: 16px;
            }

            .tds-input {
                padding: 12px;
                font-size: 20px;
                letter-spacing: 4px;
            }

            .tds-timer {
                padding: 10px;
                font-size: 12px;
            }

            .tds-timer span {
                font-size: 14px;
            }

            .tds-help {
                font-size: 12px;
            }

            .tds-footer {
                padding: 14px;
                font-size: 11px;
            }

            .spinner {
                width: 45px;
                height: 45px;
            }

            .checkmark,
            .error-icon {
                width: 60px;
                height: 60px;
                font-size: 36px;
                line-height: 60px;
            }

            .success-animation h2,
            .error-animation h2,
            .blocked-message h2,
            .payment-expired h2 {
                font-size: 20px;
            }

            .success-animation p,
            .error-animation p,
            .blocked-message p,
            .payment-expired p {
                font-size: 13px;
            }

            .receipt {
                padding: 16px;
            }

            .receipt-row {
                padding: 10px 0;
            }

            .receipt-row span,
            .receipt-row strong {
                font-size: 12px;
            }

            .card-logos {
                gap: 6px;
                margin-top: 8px;
            }

            .card-logo {
                font-size: 10px;
                padding: 3px 8px;
            }

            .blocked-message .icon,
            .payment-expired .icon {
                font-size: 56px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 12px;
            }

            .content {
                padding: 15px 12px;
            }

            .question-box {
                padding: 15px;
            }

            .image-option {
                font-size: 36px;
            }

            .text-input,
            .form-group input {
                font-size: 13px;
            }

            .btn {
                padding: 12px;
                font-size: 13px;
            }

            .payment-timer {
                font-size: 12px;
            }

            .timer-display {
                font-size: 16px;
            }

            .tds-input {
                font-size: 18px;
                letter-spacing: 3px;
            }

            .checkmark,
            .error-icon {
                width: 50px;
                height: 50px;
                font-size: 30px;
                line-height: 50px;
            }

            .success-animation h2,
            .error-animation h2 {
                font-size: 18px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 600px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’³ã€DEMOã€‘å¥½å¥½çµå¸³</h1>
            <p>ç‚ºç¢ºä¿äº¤æ˜“å®‰å…¨,è«‹å®Œæˆèº«ä»½é©—è­‰ç¨‹åº</p>
        </div>

        <div class="content">
            <!-- é©—è­‰å€åŸŸ -->
            <div class="verification-section active" id="verificationSection">
                <div class="attempts-counter" id="attemptsCounter">
                    å‰©é¤˜é©—è­‰æ¬¡æ•¸:<strong>5/5</strong>
                </div>

                <div id="errorMessage"></div>

                <div class="question-box" id="questionBox">
                    <h3 id="questionText">æ­£åœ¨è¼‰å…¥é©—è­‰...</h3>
                    <div id="challengeArea"></div>
                </div>

                <button class="btn btn-primary" id="verifyBtn" onclick="checkAnswer()">
                    é€å‡ºé©—è­‰
                </button>
            </div>

            <!-- ä»˜æ¬¾å€åŸŸ -->
            <div class="payment-section" id="paymentSection">
                <div class="success-message">
                    âœ“ èº«ä»½é©—è­‰å®Œæˆ,æ‚¨çš„äº¤æ˜“ç’°å¢ƒå·²åŠ å¯†ä¿è­·
                </div>

                <div class="payment-timer" id="paymentTimer">
                    â± å®‰å…¨é€£ç·šæœ‰æ•ˆæ™‚é–“: <span id="paymentCountdown" class="timer-display">2:00</span>
                </div>

                <form id="paymentForm">
                    <div class="form-group">
                        <label>ç”¢å“é …ç›®</label>
                        <input type="text" value="ä¼æ¥­å°ˆæ¥­æ–¹æ¡ˆ" readonly>
                    </div>

                    <div class="form-group">
                        <label>äº¤æ˜“é‡‘é¡</label>
                        <input type="text" value="NT$ 1,999" readonly>
                    </div>

                    <div class="form-group">
                        <label>ä¿¡ç”¨å¡è™Ÿ *</label>
                        <input type="text" required placeholder="1234 5678 9012 3456" maxlength="19" id="cardNumber" oninput="formatCardNumber(this)" onkeyup="autoFocusExpiry(this)">
                        <div class="card-logos">
                            <span class="card-logo">VISA</span>
                            <span class="card-logo">MasterCard</span>
                            <span class="card-logo">JCB</span>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>æœ‰æ•ˆæœŸé™ *</label>
                            <input type="text" required placeholder="MM/YY" maxlength="5" id="cardExpiry" oninput="formatExpiry(this)" onkeyup="autoFocusCVV(this)">
                        </div>
                        <div class="form-group">
                            <label>å®‰å…¨ç¢¼ *</label>
                            <input type="text" required placeholder="CVV" maxlength="3" id="cardCVV" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="handlePayment(event)">
                        ç¢ºèªäº¤æ˜“ NT$ 1,999
                    </button>
                </form>
            </div>

            <!-- å°é–å€åŸŸ -->
            <div class="verification-section" id="blockedSection">
                <div class="blocked-message">
                    <div class="icon">ğŸ”’</div>
                    <h2>å®‰å…¨é©—è­‰é€¾æ™‚é–å®š</h2>
                    <p>åŸºæ–¼å®‰å…¨è€ƒé‡,æ­¤äº¤æ˜“å·²è¢«ç³»çµ±æš«æ™‚é™åˆ¶</p>
                    <p style="margin-top: 10px; font-size: 13px; color: #adb5bd;">
                        è«‹è¯ç¹«å®¢æˆ¶æœå‹™éƒ¨é–€æˆ–ç¨å¾Œé‡æ–°å˜—è©¦
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let attempts = 5;
        let currentChallenge = null;
        let selectedImages = [];

        const challenges = {
            image: [
                {
                    question: "è«‹é¸å‡ºæ‰€æœ‰ã€Œè¾¦å…¬ç”¨å“ã€é¡åˆ¥çš„åœ–ç¤º",
                    options: ["ğŸ“", "ğŸ®", "ğŸ“Š", "ğŸŒ³", "âœï¸", "ğŸ¨", "ğŸ”", "âš½", "ğŸŒ¸"],
                    correct: ["ğŸ“", "ğŸ“Š", "âœï¸"]
                },
                {
                    question: "è«‹é¸å‡ºæ‰€æœ‰ã€Œé€šè¨Šå·¥å…·ã€ç›¸é—œåœ–ç¤º",
                    options: ["ğŸ“±", "ğŸŒ³", "ğŸ’»", "ğŸ¨", "ğŸ“§", "ğŸ®", "ğŸ”", "âš½", "ğŸŒ¸"],
                    correct: ["ğŸ“±", "ğŸ’»", "ğŸ“§"]
                },
                {
                    question: "è«‹é¸å‡ºæ‰€æœ‰ã€Œå•†å‹™å ´æ™¯ã€ç›¸é—œåœ–ç¤º",
                    options: ["ğŸ’¼", "ğŸŒ³", "ğŸ¢", "ğŸŒ¸", "ğŸ“Š", "ğŸ¨", "ğŸ”", "âš½", "ğŸ®"],
                    correct: ["ğŸ’¼", "ğŸ¢", "ğŸ“Š"]
                }
            ],
            text: [
                { question: "25 + 15 ç­‰æ–¼å¤šå°‘?", answer: "40" },
                { question: "è«‹è¼¸å…¥ã€Œå®‰å…¨é©—è­‰ã€å››å€‹å­—", answer: "å®‰å…¨é©—è­‰" },
                { question: "100 - 35 ç­‰æ–¼å¤šå°‘?", answer: "65" },
                { question: "ä¸€å¹´æœ‰å¹¾å­£?", answer: "4" },
                { question: "8 Ã— 7 ç­‰æ–¼å¤šå°‘?", answer: "56" },
                { question: "è«‹è¼¸å…¥ã€Œä¼æ¥­ã€å…©å€‹å­—", answer: "ä¼æ¥­" },
                { question: "72 - 28 ç­‰æ–¼å¤šå°‘?", answer: "44" },
                { question: "9 Ã— 6 ç­‰æ–¼å¤šå°‘?", answer: "54" },
                { question: "45 + 23 ç­‰æ–¼å¤šå°‘?", answer: "68" },
                { question: "7 Ã— 8 ç­‰æ–¼å¤šå°‘?", answer: "56" },
                { question: "90 - 47 ç­‰æ–¼å¤šå°‘?", answer: "43" },
                { question: "6 Ã— 9 ç­‰æ–¼å¤šå°‘?", answer: "54" },
                { question: "å°ç£çš„é¦–éƒ½æ˜¯?", answer: "å°åŒ—" },
                { question: "ä¸€å‘¨æœ‰å¹¾å¤©?", answer: "7" },
                { question: "ä¸€å¹´æœ‰å¹¾å€‹æœˆ?", answer: "12" },
                { question: "ä¸€å¤©æœ‰å¹¾å°æ™‚?", answer: "24" },
                { question: "å°ç£çš„è²¨å¹£å–®ä½æ˜¯?(è«‹è¼¸å…¥å…©å€‹å­—)", answer: "æ–°å°å¹£" }
            ]
        };

        function loadChallenge() {
            const type = Math.random() > 0.5 ? 'image' : 'text';

            if (type === 'image') {
                const challenge = challenges.image[Math.floor(Math.random() * challenges.image.length)];
                currentChallenge = { type: 'image', data: challenge };

                document.getElementById('questionText').textContent = challenge.question;

                const grid = document.createElement('div');
                grid.className = 'image-grid';

                challenge.options.forEach(emoji => {
                    const div = document.createElement('div');
                    div.className = 'image-option';
                    div.textContent = emoji;
                    div.onclick = () => toggleImage(div, emoji);
                    grid.appendChild(div);
                });

                document.getElementById('challengeArea').innerHTML = '';
                document.getElementById('challengeArea').appendChild(grid);
                selectedImages = [];
            } else {
                const challenge = challenges.text[Math.floor(Math.random() * challenges.text.length)];
                currentChallenge = { type: 'text', data: challenge };

                document.getElementById('questionText').textContent = challenge.question;

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'text-input';
                input.id = 'answerInput';
                input.placeholder = 'è«‹è¼¸å…¥ç­”æ¡ˆ';

                document.getElementById('challengeArea').innerHTML = '';
                document.getElementById('challengeArea').appendChild(input);
            }
        }

        function toggleImage(element, emoji) {
            element.classList.toggle('selected');
            const index = selectedImages.indexOf(emoji);
            if (index > -1) {
                selectedImages.splice(index, 1);
            } else {
                selectedImages.push(emoji);
            }
        }

        function checkAnswer() {
            let isCorrect = false;

            if (currentChallenge.type === 'image') {
                const correct = currentChallenge.data.correct.sort();
                const selected = selectedImages.sort();
                isCorrect = JSON.stringify(correct) === JSON.stringify(selected);
            } else {
                const userAnswer = document.getElementById('answerInput').value.trim();
                isCorrect = userAnswer === currentChallenge.data.answer;
            }

            if (isCorrect) {
                showPaymentSection();
            } else {
                attempts--;
                updateAttemptsCounter();

                if (attempts <= 0) {
                    showBlockedSection();
                } else {
                    showError('âœ— é©—è­‰å¤±æ•—,è«‹é‡æ–°å˜—è©¦');
                    loadChallenge();
                }
            }
        }

        function updateAttemptsCounter() {
            const counter = document.getElementById('attemptsCounter');
            counter.innerHTML = `å‰©é¤˜é©—è­‰æ¬¡æ•¸:<strong>${attempts}/5</strong>`;
            if (attempts <= 2) {
                counter.classList.add('danger');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 3000);
        }

        function showPaymentSection() {
            document.getElementById('verificationSection').classList.remove('active');
            document.getElementById('paymentSection').classList.add('active');
            startPaymentTimer();
        }

        function showBlockedSection() {
            document.getElementById('verificationSection').classList.remove('active');
            document.getElementById('blockedSection').classList.add('active');
        }

        let paymentTimerInterval;
        function startPaymentTimer() {
            let timeLeft = 120;
            const timerDisplay = document.getElementById('paymentCountdown');
            const timerBox = document.getElementById('paymentTimer');

            paymentTimerInterval = setInterval(() => {
                timeLeft--;

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 30) {
                    timerBox.classList.add('warning');
                }

                if (timeLeft <= 0) {
                    clearInterval(paymentTimerInterval);
                    showPaymentExpired();
                }
            }, 1000);
        }

        function showPaymentExpired() {
            const paymentSection = document.getElementById('paymentSection');
            paymentSection.innerHTML = `
                <div class="payment-expired">
                    <div class="icon">â±</div>
                    <h2>å®‰å…¨é€£ç·šå·²é€¾æ™‚</h2>
                    <p>ç‚ºç¢ºä¿äº¤æ˜“å®‰å…¨,æ­¤ä»˜æ¬¾é€£ç·šå·²è‡ªå‹•é—œé–‰</p>
                    <p style="font-size: 13px; color: #adb5bd;">
                        è«‹é‡æ–°é€²è¡Œèº«ä»½é©—è­‰ä»¥ç¹¼çºŒäº¤æ˜“
                    </p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        é‡æ–°é–‹å§‹é©—è­‰
                    </button>
                </div>
            `;
        }

        function handlePayment(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            // å–å¾—ä¿¡ç”¨å¡è³‡è¨Š
            const cardNumber = document.getElementById('cardNumber');
            const cardExpiry = document.getElementById('cardExpiry');
            const cardCVV = document.getElementById('cardCVV');

            // æª¢æŸ¥å¿…å¡«æ¬„ä½
            if (!cardNumber || !cardExpiry || !cardCVV) {
                alert('é é¢è¼‰å…¥éŒ¯èª¤,è«‹é‡æ–°æ•´ç†');
                return false;
            }

            if (!cardNumber.value.trim()) {
                alert('è«‹è¼¸å…¥ä¿¡ç”¨å¡è™Ÿ');
                cardNumber.focus();
                return false;
            }

            if (!cardExpiry.value.trim()) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆæœŸé™');
                cardExpiry.focus();
                return false;
            }

            if (!cardCVV.value.trim()) {
                alert('è«‹è¼¸å…¥å®‰å…¨ç¢¼');
                cardCVV.focus();
                return false;
            }

            // å–å¾—å¡è™Ÿå¾Œ 4 ç¢¼
            const cardNumberValue = cardNumber.value.replace(/\s/g, '');
            const last4Digits = cardNumberValue.slice(-4) || '3456';

            // åœæ­¢ä»˜æ¬¾å€’æ•¸è¨ˆæ™‚
            if (typeof paymentTimerInterval !== 'undefined') {
                clearInterval(paymentTimerInterval);
            }

            // é€²å…¥ 3DS é©—è­‰
            show3DSVerification(last4Digits);
            return false;
        }

        function show3DSVerification(last4 = '3456') {
            currentLast4Digits = last4; // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸
            const paymentSection = document.getElementById('paymentSection');
            paymentSection.innerHTML = `
                <div class="tds-container">
                    <div class="tds-header">
                        <div style="color: white; font-weight: 600; font-size: 15px;">ğŸ”’ Visa Secure</div>
                        <div class="tds-lock">ğŸ›¡ï¸</div>
                    </div>

                    <div class="tds-content">
                        <div class="tds-info">
                            <h3>éŠ€è¡Œå®‰å…¨é©—è­‰</h3>
                            <p>æ‚¨çš„ç™¼å¡éŠ€è¡Œè¦æ±‚é€²è¡Œé¡å¤–çš„äº¤æ˜“é©—è­‰</p>
                        </div>

                        <div class="tds-transaction">
                            <div class="tds-row">
                                <span>æ”¶æ¬¾å•†å®¶</span>
                                <strong>ä¼æ¥­é›»å•†å¹³å°</strong>
                            </div>
                            <div class="tds-row">
                                <span>äº¤æ˜“é‡‘é¡</span>
                                <strong>NT$ 1,999</strong>
                            </div>
                            <div class="tds-row">
                                <span>ä¿¡ç”¨å¡è™Ÿ</span>
                                <strong>**** **** **** ${last4}</strong>
                            </div>
                            <div class="tds-row">
                                <span>äº¤æ˜“æ—¥æœŸ</span>
                                <strong>${new Date().toLocaleDateString('zh-TW')}</strong>
                            </div>
                        </div>

                        <div class="tds-verify-box">
                            <p class="tds-sms-info">ç°¡è¨Šé©—è­‰ç¢¼å·²ç™¼é€è‡³æ‚¨çš„è¨»å†Šæ‰‹æ©Ÿ</p>
                            <p class="tds-phone">æ‰‹æ©Ÿè™Ÿç¢¼: 09** *** 678</p>

                            <div class="form-group">
                                <label>è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼</label>
                                <input type="text"
                                       id="tdsCode"
                                       class="tds-input"
                                       maxlength="6"
                                       placeholder="______"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>

                            <div class="tds-timer" id="tdsTimer">
                                é©—è­‰ç¢¼æœ‰æ•ˆæœŸé™: <span id="countdown">180</span> ç§’
                            </div>

                            <button class="btn btn-primary" onclick="verify3DS()">
                                é€å‡ºé©—è­‰
                            </button>

                            <button class="btn btn-secondary" onclick="cancel3DS()">
                                å–æ¶ˆæœ¬æ¬¡äº¤æ˜“
                            </button>

                            <p class="tds-help">
                                <small>æ¸¬è©¦èªªæ˜: è¼¸å…¥ <strong>ä»»æ„6ä½æ•¸å­—</strong> é©—è­‰æˆåŠŸ / <strong>000000</strong> é©—è­‰å¤±æ•—</small>
                            </p>
                        </div>

                        <div class="tds-footer">
                            <p>ğŸ” æ­¤é©—è­‰ç¨‹åºç”±æ‚¨çš„ç™¼å¡éŠ€è¡Œæä¾›,ç¢ºä¿äº¤æ˜“å®‰å…¨ç„¡è™</p>
                        </div>
                    </div>
                </div>
            `;

            startCountdown();
        }

        let countdownInterval;
        let currentLast4Digits = '3456'; // å„²å­˜å¡è™Ÿå¾Œå››ç¢¼
        
        function startCountdown() {
            let timeLeft = 180;
            const countdownElement = document.getElementById('countdown');

            countdownInterval = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;

                if (timeLeft <= 30) {
                    countdownElement.style.color = '#dc3545';
                }

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    show3DSTimeout();
                }
            }, 1000);
        }

        function verify3DS() {
            const code = document.getElementById('tdsCode').value;

            if (code.length !== 6) {
                alert('è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼');
                return;
            }

            clearInterval(countdownInterval);

            // é¡¯ç¤ºé©—è­‰ä¸­ç•«é¢
            document.getElementById('paymentSection').innerHTML = `
                <div class="tds-container">
                    <div class="loading-animation">
                        <div class="spinner"></div>
                        <h3>ç³»çµ±é©—è­‰ä¸­</h3>
                        <p>è«‹ç¨å€™,æ­£åœ¨é€²è¡Œå®‰å…¨æ€§ç¢ºèª...</p>
                    </div>
                </div>
            `;

            // æ¨¡æ“¬é©—è­‰è™•ç†
            setTimeout(() => {
                if (code === '000000') {
                    // é©—è­‰å¤±æ•—
                    show3DSFailed();
                } else {
                    // ä»»æ„å…¶ä»–6ä½æ•¸å­—éƒ½é©—è­‰æˆåŠŸ
                    show3DSSuccess();
                }
            }, 2000);
        }

        function show3DSFailed() {
            document.getElementById('paymentSection').innerHTML = `
                <div class="tds-container">
                    <div class="error-animation">
                        <div class="error-icon">âœ—</div>
                        <h2>é©—è­‰æœªé€šé</h2>
                        <p>é©—è­‰ç¢¼è¼¸å…¥éŒ¯èª¤,è«‹ç¢ºèªå¾Œé‡æ–°å˜—è©¦</p>

                        <button class="btn btn-primary" onclick="show3DSVerification()">
                            é‡æ–°é©—è­‰
                        </button>

                        <button class="btn btn-secondary" onclick="location.reload()">
                            è¿”å›é¦–é 
                        </button>
                    </div>
                </div>
            `;
        }

        function show3DSError() {
            document.getElementById('paymentSection').innerHTML = `
                <div class="tds-container">
                    <div class="error-animation">
                        <div class="error-icon">âš ï¸</div>
                        <h2>é©—è­‰ç¢¼ä¸æ­£ç¢º</h2>
                        <p>è«‹è¼¸å…¥æ­£ç¢ºçš„ 6 ä½æ•¸é©—è­‰ç¢¼</p>
                        <p style="font-size: 13px; color: #adb5bd; margin-top: 10px;">
                            æç¤º:è¼¸å…¥ä»»æ„6ä½æ•¸å­—(é™¤000000å¤–)å³å¯æˆåŠŸ
                        </p>

                        <button class="btn btn-primary" onclick="show3DSVerification()">
                            é‡æ–°é©—è­‰
                        </button>

                        <button class="btn btn-secondary" onclick="location.reload()">
                            è¿”å›é¦–é 
                        </button>
                    </div>
                </div>
            `;
        }

        function formatCardNumber(input) {
            let value = input.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            input.value = formattedValue;
        }

        function autoFocusExpiry(input) {
            // ç§»é™¤ç©ºæ ¼å¾Œæª¢æŸ¥é•·åº¦
            const value = input.value.replace(/\s/g, '');
            if (value.length === 16) {
                const expiryInput = document.getElementById('cardExpiry');
                if (expiryInput) {
                    expiryInput.focus();
                }
            }
        }

        function formatExpiry(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            input.value = value;
        }

        function autoFocusCVV(input) {
            // æª¢æŸ¥æ˜¯å¦å·²è¼¸å…¥å®Œæ•´çš„ MM/YY æ ¼å¼
            if (input.value.length === 5) {
                const cvvInput = document.getElementById('cardCVV');
                if (cvvInput) {
                    cvvInput.focus();
                }
            }
        }

        function show3DSSuccess() {
            document.getElementById('paymentSection').innerHTML = `
                <div class="tds-container">
                    <div class="success-animation">
                        <div class="checkmark">âœ“</div>
                        <h2>äº¤æ˜“å®Œæˆ</h2>
                        <p>æ‚¨çš„ä»˜æ¬¾å·²æˆåŠŸè™•ç†</p>

                        <div class="receipt">
                            <div class="receipt-row">
                                <span>äº¤æ˜“ç·¨è™Ÿ</span>
                                <strong>#${Math.random().toString(36).substr(2, 9).toUpperCase()}</strong>
                            </div>
                            <div class="receipt-row">
                                <span>äº¤æ˜“é‡‘é¡</span>
                                <strong>NT$ 1,999</strong>
                            </div>
                            <div class="receipt-row">
                                <span>äº¤æ˜“æ™‚é–“</span>
                                <strong>${new Date().toLocaleString('zh-TW')}</strong>
                            </div>
                            <div class="receipt-row">
                                <span>ä»˜æ¬¾æ–¹å¼</span>
                                <strong>ä¿¡ç”¨å¡ (**** ${currentLast4Digits})</strong>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="window.print()">
                            åˆ—å°äº¤æ˜“æ˜ç´°
                        </button>
                    </div>
                </div>
            `;
        }

        function show3DSTimeout() {
            document.getElementById('paymentSection').innerHTML = `
                <div class="tds-container">
                    <div class="error-animation">
                        <div class="error-icon">â±</div>
                        <h2>é©—è­‰é€¾æ™‚</h2>
                        <p>é©—è­‰ç¢¼å·²è¶…éæœ‰æ•ˆæœŸé™,è«‹é‡æ–°å–å¾—</p>

                        <button class="btn btn-primary" onclick="show3DSVerification()">
                            é‡æ–°é©—è­‰
                        </button>

                        <button class="btn btn-secondary" onclick="location.reload()">
                            è¿”å›é¦–é 
                        </button>
                    </div>
                </div>
            `;
        }

        function cancel3DS() {
            clearInterval(countdownInterval);
            if (confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤ç­†äº¤æ˜“å—?')) {
                clearInterval(paymentTimerInterval);
                document.getElementById('paymentSection').innerHTML = `
                    <div class="tds-container">
                        <div class="error-animation">
                            <div class="error-icon">âœ—</div>
                            <h2>äº¤æ˜“å·²å–æ¶ˆ</h2>
                            <p>æ‚¨å·²å–æ¶ˆæœ¬æ¬¡ä»˜æ¬¾äº¤æ˜“</p>

                            <button class="btn btn-primary" onclick="location.reload()">
                                è¿”å›é¦–é 
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function resend3DS() {
            alert('âœ… é©—è­‰ç¢¼å·²é‡æ–°ç™¼é€!\n\n(é€™æ˜¯ç¤ºç¯„åŠŸèƒ½)');
            clearInterval(countdownInterval);
            startCountdown();
        }

        loadChallenge();
    </script>
</body>

</html>